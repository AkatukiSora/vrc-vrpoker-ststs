[tools]
go = "1.25.0"
lefthook = "2.1.1"

[env]
BINARY = "vrpoker-stats"
BUILD_TAGS = "wayland"
CGO_ENABLED = "1"

# ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

[tasks.build]
description = "Build the binary (Wayland)"
run = '''
  VERSION="${VERSION:-dev}"
  COMMIT="${COMMIT:-local}"
  BUILD_DATE="${BUILD_DATE:-unknown}"
  go build -tags "$BUILD_TAGS" \
    -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE}" \
    -o "$BINARY" .
'''
sources = ["**/*.go", "go.mod", "go.sum"]
outputs = ["{{env.BINARY}}"]

[tasks.build-debug]
description = "Build with debug info (no stripping)"
run = '''
  VERSION="${VERSION:-dev}"
  COMMIT="${COMMIT:-local}"
  BUILD_DATE="${BUILD_DATE:-unknown}"
  go build -tags "$BUILD_TAGS" \
    -ldflags "-X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE}" \
    -o "${BINARY}-debug" .
'''

[tasks.build-windows]
description = "Cross-build Windows amd64 binary (requires MinGW)"
run = '''
  if ! command -v x86_64-w64-mingw32-gcc >/dev/null 2>&1; then
    echo "Error: x86_64-w64-mingw32-gcc not found"
    echo "Install MinGW first, e.g. on Ubuntu: sudo apt-get install -y mingw-w64"
    exit 1
  fi
  VERSION="${VERSION:-dev}"
  COMMIT="${COMMIT:-local}"
  BUILD_DATE="${BUILD_DATE:-unknown}"
  CGO_ENABLED=1 GOOS=windows GOARCH=amd64 CC=x86_64-w64-mingw32-gcc \
    go build -ldflags "-s -w -X main.version=${VERSION} -X main.commit=${COMMIT} -X main.buildDate=${BUILD_DATE}" \
    -o "${BINARY}.exe" .
'''

[tasks.deps-linux]
description = "Install Linux build dependencies (Wayland + MinGW cross toolchain)"
run = '''
  if ! command -v apt-get >/dev/null 2>&1; then
    echo "Error: apt-get not found. Install dependencies manually for your distro."
    exit 1
  fi

  sudo apt-get update -qq
  sudo apt-get install -y --no-install-recommends \
    libwayland-dev \
    libxkbcommon-dev \
    libegl-dev \
    libgles2-mesa-dev \
    pkg-config \
    gcc \
    mingw-w64 \
    zip
'''

[tasks.check-toolchain]
description = "Check required local toolchain binaries"
run = '''
  command -v go
  command -v gcc || echo "warn: gcc not found (Linux native build may fail)"
  command -v pkg-config || echo "warn: pkg-config not found (Linux native build may fail)"
  command -v x86_64-w64-mingw32-gcc || echo "warn: MinGW not found (Windows cross-build unavailable)"
  mise exec -- lefthook version
'''

[tasks.run]
description = "Build and run (Wayland)"
depends = ["build"]
run = './"$BINARY"'

[tasks.test]
description = "Run unit tests (parser/stats/watcher only; UI has no tests)"
run = 'go test -v -run "Test[^R]" ./internal/parser/... ./internal/stats/... ./internal/watcher/...'

[tasks.test-all]
description = "Run all tests including real VRChat log integration test"
run = "go test -v ./internal/parser/... ./internal/stats/... ./internal/watcher/..."

[tasks.test-parser]
description = "Run parser tests only"
run = "go test -v ./internal/parser/..."

[tasks.lint]
description = "Run go vet"
run = "go vet -tags \"$BUILD_TAGS\" ./..."

[tasks.tidy]
description = "Tidy go modules"
run = "go mod tidy"

[tasks.check-i18n]
description = "Check UI strings use i18n wrappers"
run = "go run ./tools/check_i18n"

[tasks.clean]
description = "Remove build artifacts"
run = 'rm -f "$BINARY" "${BINARY}-debug"'

[tasks.setup]
description = "Set up development environment (install lefthook, tidy modules)"
run = '''
  echo "üîß Setting up development environment..."
  
  # Tidy Go modules
  echo "üì¶ Tidying Go modules..."
  go mod tidy
  
  echo "üì• Installing tools declared in mise.toml..."
  mise install

  echo "üß™ Checking required toolchain commands..."
  mise run check-toolchain
  
  # Install lefthook git hooks
  echo "ü™ù Installing git hooks via lefthook..."
  mise exec -- lefthook install -f
  
  echo "‚ú® Development environment setup complete!"
  echo ""
  echo "Next steps:"
  echo "  - On Ubuntu/Debian, run 'mise run deps-linux' once for native deps"
  echo "  - Review lefthook.yaml for hook configuration"
  echo "  - Run 'mise run build' to build the binary"
  echo "  - Run 'mise run test' to run tests"
'''

[tasks.ci]
description = "Run full CI pipeline locally (lint + test + build)"
depends = ["lint", "test", "build"]
