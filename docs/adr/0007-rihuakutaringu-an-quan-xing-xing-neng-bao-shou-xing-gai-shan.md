# 7. リファクタリング: 安全性/性能/保守性改善

Date: 2026-02-27
日付: 2026-02-27

## Status

accepted

## 背景

直近の改修で、以下の課題が顕在化した。

- SQL の動的文字列組み立てによる注入リスク
- Log watcher の読み取り競合と可変コールバックの競合リスク
- Hand range UI の全再構築による高コスト描画
- リポジトリ層/統計層の重複実装による保守性の低下
- 共有参照の流出による状態破壊の可能性

これらを整理し、安全性・性能・継続開発性を同時に改善する方針を明文化する。

## 決定

以下の方針でリファクタリングを実施する。

1. SQL 実行時の動的テーブル名はホワイトリスト化し、注入リスクを排除する。
2. watcher のコールバックは生成時に固定し、読み取り処理は直列化して競合を防止する。
3. Hand range UI はセルを保持し、データ更新時は `Refresh()` のみで反映する。
4. 手札レンジのキーは `ComboKey()` を正規キーとして採用し、表示は `comboDisplayLabel()` に分離する。
5. `Compute()` が返す統計は深いコピーを返し、内部状態の共有を禁止する。
6. リポジトリ層の hand scan と統計判定ロジックは共通化し、重複を排除する。
7. ActiveSeats は集合を併用し、線形探索を廃止する。

## 結果

### メリット
- SQL 注入・並行競合・共有参照のリスク低減
- UI リビルド削減による描画コストの低下
- 変更点が一箇所に集まり、保守性が向上

### トレードオフ
- リファクタリング範囲が広く、差分が大きくなる
- 一部 API 変更（設定タブ・watcher）により呼び出し側の修正が必要
